<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>D2BirthdayApp!</title>
    
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@600;800&family=Roboto:wght@400;500;700&display=swap" rel="stylesheet">
    
    <style>
        :root {
            --brand-green: #126c39;
            --brand-red: #a9181d;
            --bg-color: #F0f0f0;
            --white: #ffffff;
            
            /* Priority Colors */
            --p1-color: #a9181d; 
            --p2-color: #f57f17; 
            --p3-color: #0277bd; 
            --p4-color: #2e7d32; 
            --p5-color: #607D8B; 
            
            --shadow: 0 10px 20px rgba(0,0,0,0.05);
            --corner-radius: 15px;
            --spacing: 30px;
        }

        body { font-family: 'Roboto', sans-serif; background: var(--bg-color); margin: 0; padding: 0; color: #444; }

        /* HEADER */
        header {
            background: var(--bg-color);
            padding: 20px 40px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 10px;
        }
        h1 {
            font-family: 'Poppins', sans-serif;
            font-weight: 800;
            font-size: 2.5rem;
            margin: 0;
            letter-spacing: -1px;
        }
        .t-green { color: var(--brand-green); }
        .t-red { color: var(--brand-red); }
        
        /* BUTTONS */
        .btn-main {
            background: var(--brand-green); /* Green as requested */
            color: white;
            border: none;
            padding: 12px 25px;
            font-family: 'Poppins', sans-serif;
            font-weight: 600;
            font-size: 0.95rem;
            border-radius: var(--corner-radius);
            cursor: pointer;
            transition: all 0.2s;
            box-shadow: 0 4px 10px rgba(18, 108, 57, 0.3);
        }
        .btn-main:hover { transform: translateY(-2px); filter: brightness(1.1); }
        .btn-resync { background: var(--brand-red); box-shadow: 0 4px 10px rgba(169, 24, 29, 0.3); }

        .container { max-width: 1600px; margin: 0 auto; padding: 0 40px 50px 40px; }

        /* DASHBOARD CARDS */
        .dashboard-cards { 
            display: grid; 
            grid-template-columns: repeat(auto-fit, minmax(240px, 1fr)); 
            gap: var(--spacing); 
            margin-bottom: var(--spacing); 
        }
        .card { 
            background: var(--white); 
            padding: 25px; 
            border-radius: var(--corner-radius); 
            box-shadow: var(--shadow); 
            cursor: pointer;
            transition: transform 0.2s, box-shadow 0.2s;
            position: relative;
            overflow: hidden;
        }
        .card::after { content: ''; position: absolute; top: 0; left: 0; width: 100%; height: 6px; background: #ccc; }
        .card.c-today::after { background: var(--brand-green); }
        .card.c-prio::after { background: var(--brand-red); }
        .card.c-upcoming::after { background: #f9a825; }
        .card.c-total::after { background: #333; }
        .card:hover { transform: translateY(-5px); box-shadow: 0 15px 30px rgba(0,0,0,0.1); }
        
        .card h3 { 
            font-family: 'Poppins', sans-serif; 
            font-weight: 600;
            margin: 10px 0 5px 0; 
            font-size: 1rem; 
            color: #888; 
            text-transform: uppercase;
            letter-spacing: 1px;
        }
        .card .val { font-family: 'Poppins', sans-serif; font-size: 3.5rem; font-weight: 800; color: #222; line-height: 1.1; }

        /* CONTROLS */
        .controls { 
            display: flex; 
            gap: 20px; 
            flex-wrap: wrap; 
            align-items: center; 
            background: var(--white); 
            padding: 20px 30px; 
            border-radius: var(--corner-radius);
            margin-bottom: var(--spacing);
            box-shadow: var(--shadow);
        }
        select, input[type="text"] { 
            padding: 12px 15px; 
            border: 2px solid #eee; 
            border-radius: 10px; 
            font-family: 'Roboto', sans-serif;
            font-size: 1rem;
            background: #fcfcfc;
        }
        select:focus, input:focus { border-color: var(--brand-green); outline: none; }

        /* TOGGLE SWITCH */
        .toggle-container { display: flex; align-items: center; gap: 12px; background: #f0f0f0; padding: 8px 15px 8px 8px; border-radius: 30px; }
        .switch { position: relative; display: inline-block; width: 50px; height: 28px; }
        .switch input { opacity: 0; width: 0; height: 0; }
        .slider { position: absolute; cursor: pointer; top: 0; left: 0; right: 0; bottom: 0; background-color: #ccc; transition: .4s; border-radius: 34px; }
        .slider:before { position: absolute; content: ""; height: 22px; width: 22px; left: 3px; bottom: 3px; background-color: white; transition: .4s; border-radius: 50%; box-shadow: 0 2px 4px rgba(0,0,0,0.2); }
        input:checked + .slider { background-color: var(--brand-red); }
        input:checked + .slider:before { transform: translateX(22px); }
        .toggle-label { font-family: 'Poppins', sans-serif; font-weight: 700; color: #555; font-size: 0.9rem; }

        /* NOTIFICATION & LOADER */
        #count-display {
            text-align: center;
            margin-bottom: 15px;
            font-weight: 600;
            color: #666;
            display: flex;
            justify-content: center;
            align-items: center;
            gap: 10px;
            height: 30px;
        }
        .spinner {
            width: 20px; height: 20px;
            border: 3px solid #ccc;
            border-top-color: var(--brand-green);
            border-radius: 50%;
            animation: spin 0.8s linear infinite;
            display: none;
        }
        @keyframes spin { to {transform: rotate(360deg);} }

        /* TABLE */
        .table-panel { background: var(--white); border-radius: var(--corner-radius); box-shadow: var(--shadow); overflow: hidden; margin-bottom: var(--spacing); }
        .table-wrap { overflow-x: auto; max-height: 60vh; }
        table { width: 100%; border-collapse: collapse; font-size: 1rem; }
        th { 
            background: var(--white); color: #888; 
            font-family: 'Poppins', sans-serif; font-weight: 800; 
            text-transform: uppercase; text-align: left; padding: 20px 25px;
            position: sticky; top: 0; border-bottom: 3px solid #f0f0f0; z-index: 10;
        }
        td { padding: 18px 25px; border-bottom: 1px solid #f5f5f5; color: #444; }
        tr:hover { background: #fafafa; }
        
        /* BADGES & TYPOGRAPHY */
        .badge { padding: 5px 10px; border-radius: 8px; font-size: 0.8rem; font-weight: 700; color: white; display: inline-block; min-width: 30px; text-align: center; }
        .badge[data-p="1"] { background: var(--p1-color); }
        .badge[data-p="2"] { background: var(--p2-color); color: white; }
        .badge[data-p="3"] { background: var(--p3-color); }
        .badge[data-p="4"] { background: var(--p4-color); }
        .badge[data-p="5"] { background: var(--p5-color); }
        .name-p1 { font-weight: 900; color: var(--p1-color); font-size: 1.1rem; }
        .name-p2 { font-weight: 700; color: var(--p2-color); }
        
        /* CHARTS SECTION */
        .charts-header { font-family: 'Poppins', sans-serif; font-weight: 800; font-size: 1.5rem; color: #ccc; margin-bottom: 20px; margin-top: 10px; border-bottom: 2px solid #e0e0e0; padding-bottom: 10px; }
        .stats-grid { display: grid; grid-template-columns: 2fr 1fr; gap: var(--spacing); }
        .chart-box { background: white; padding: 30px; border-radius: var(--corner-radius); box-shadow: var(--shadow); height: 400px; }

        /* MODALS */
        .modal { display: none; position: fixed; z-index: 1000; left: 0; top: 0; width: 100%; height: 100%; background-color: rgba(255,255,255,0.95); backdrop-filter: blur(5px); }
        .modal-content { 
            background-color: #fff; margin: 4% auto; padding: 0; 
            border-radius: var(--corner-radius); width: 85%; max-width: 1200px; 
            height: 85vh; display: flex; flex-direction: column;
            box-shadow: 0 25px 60px rgba(0,0,0,0.3); border: 1px solid #eee;
            animation: floatUp 0.4s cubic-bezier(0.175, 0.885, 0.32, 1.275);
        }
        @keyframes floatUp { from {transform: translateY(50px); opacity: 0;} to {transform: translateY(0); opacity: 1;} }
        .modal-header { padding: 25px 30px; display: flex; justify-content: space-between; align-items: center; border-bottom: 1px solid #f0f0f0; }
        .modal-header h2 { margin: 0; font-family: 'Poppins', sans-serif; font-weight: 800; color: var(--brand-green); font-size: 2rem;}
        .close-btn { color: #aaa; font-size: 40px; font-weight: bold; cursor: pointer; line-height: 0.5; transition: color 0.2s; }
        .close-btn:hover { color: var(--brand-red); }
        .modal-body { padding: 30px; overflow-y: auto; flex-grow: 1; }
        .modal-chart-container { height: 100%; width: 100%; }

        /* LOADER */
        #import-screen { height: 100vh; display: flex; flex-direction: column; justify-content: center; align-items: center; background: var(--bg-color); }
        
        @media (max-width: 768px) {
            .dashboard-cards { grid-template-columns: 1fr 1fr; }
            .stats-grid { grid-template-columns: 1fr; }
            th:nth-child(3), td:nth-child(3) { position: sticky; left: 0; background: inherit; z-index: 15; box-shadow: 2px 0 5px rgba(0,0,0,0.05); }
        }
    </style>
</head>
<body>

    <div id="import-screen">
        <h1 style="font-size: 3rem;"><span class="t-green">D2</span><span class="t-red">BirthdayApp!</span></h1>
        <p style="font-family: 'Poppins'; color: #888; margin-top: 10px;">SYSTEM LOADING...</p>
        <button id="btn-import" class="btn-main" style="font-size: 1.2rem; padding: 15px 50px; margin-top: 30px;">LOAD DATABASE</button>
        <div style="width: 300px; height: 6px; background: #ddd; border-radius: 10px; margin-top: 30px; overflow: hidden;">
            <div id="progress-bar" style="height: 100%; width: 0%; background: var(--brand-green); transition: width 0.3s;"></div>
        </div>
        <p id="status-text" style="margin-top: 15px; color: #aaa; font-weight: 600; font-size: 0.9rem;">Ready.</p>
    </div>

    <div id="app-screen" style="display: none;">
        <header>
            <h1><span class="t-green">D2</span><span class="t-red">BirthdayApp!</span></h1>
            <div style="display: flex; gap: 15px;">
                <button onclick="document.getElementById('modal-add').style.display='block'" class="btn-main">+ Add Official</button>
                <button onclick="if(confirm('Re-Sync will wipe data. Continue?')) location.reload()" class="btn-main btn-resync">Re-Sync</button>
            </div>
        </header>

        <div class="container">
            
            <div class="dashboard-cards">
                <div class="card c-today" onclick="openQuickView('today')">
                    <h3>Today's Birthdays</h3>
                    <div class="val" id="d-today">-</div>
                </div>
                <div class="card c-prio" onclick="openQuickView('priority')">
                    <h3>Priority</h3>
                    <div class="val" id="d-prio">-</div>
                </div>
                <div class="card c-upcoming" onclick="openQuickView('upcoming')">
                    <h3>Upcoming 7 Days</h3>
                    <div class="val" id="d-upcoming">-</div>
                </div>
                <div class="card c-total" onclick="openTotalStats()"> <h3>Total Officials</h3>
                    <div class="val" id="d-total">-</div>
                </div>
            </div>

            <div class="controls">
                <input type="text" id="filter-search" placeholder="Search Name..." style="width: 280px;">
                
                <select id="filter-mun"><option value="">All Municipalities</option></select>
                <select id="filter-month">
                    <option value="">All Months</option>
                    <option value="1">Jan</option><option value="2">Feb</option><option value="3">Mar</option>
                    <option value="4">Apr</option><option value="5">May</option><option value="6">Jun</option>
                    <option value="7">Jul</option><option value="8">Aug</option><option value="9">Sep</option>
                    <option value="10">Oct</option><option value="11">Nov</option><option value="12">Dec</option>
                </select>

                <div class="toggle-container">
                    <label class="switch">
                        <input type="checkbox" id="toggle-priority">
                        <span class="slider"></span>
                    </label>
                    <span class="toggle-label">Toggle Priority</span> </div>
                
                <div style="flex-grow: 1; text-align: right;">
                        <button class="btn-main" onclick="handleExportCSV()">Export CSV</button>
                </div>
            </div>

            <div id="count-display">
                <div class="spinner" id="loading-spinner"></div>
                <span id="count-text">Loading...</span>
            </div>

            <div class="table-panel">
                <div class="table-wrap">
                    <table id="main-table">
                        <thead>
                            <tr>
                                <th onclick="handleSort('priority')" style="cursor: pointer;">Pri</th>
                                <th onclick="handleSort('bday')" style="cursor: pointer;">Birthday</th>
                                <th onclick="handleSort('name')" style="cursor: pointer;">Name</th>
                                <th>Position</th>
                                <th>Barangay</th>
                                <th onclick="handleSort('mun')" style="cursor: pointer;">Municipality</th>
                                <th>Contact</th>
                                <th>Action</th>
                            </tr>
                        </thead>
                        <tbody id="table-body"></tbody>
                    </table>
                </div>
            </div>

            <div id="charts-section">
                <div class="charts-header">STATISTICS & REPORTS</div>
                <div class="stats-grid">
                    <div class="chart-box"><canvas id="chart-distribution"></canvas></div>
                    <div class="chart-box"><canvas id="chart-pie"></canvas></div>
                </div>
            </div>

        </div>
    </div>

    <div id="modal-quick" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2 id="modal-title">Quick View</h2>
                <span class="close-btn" onclick="document.getElementById('modal-quick').style.display='none'">&times;</span>
            </div>
            <div class="modal-body">
                <div class="table-wrap">
                    <table id="modal-table">
                        <thead>
                            <tr><th>Pri</th><th>Birthday</th><th>Name</th><th>Position</th><th>Contact</th><th>Action</th></tr>
                        </thead>
                        <tbody id="modal-body-content"></tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>

    <div id="modal-total" class="modal">
        <div class="modal-content" style="height: 70vh; max-width: 900px;">
            <div class="modal-header">
                <h2>Total Officials: Monthly Birthday Load</h2>
                <span class="close-btn" onclick="document.getElementById('modal-total').style.display='none'">&times;</span>
            </div>
            <div class="modal-body">
                <div class="modal-chart-container">
                    <canvas id="chart-total-popup"></canvas>
                </div>
            </div>
        </div>
    </div>

    <div id="modal-add" class="modal">
        <div class="modal-content" style="width: 450px; height: auto; max-height: 90vh;">
            <div class="modal-header"><h2>Add Official</h2><span class="close-btn" onclick="document.getElementById('modal-add').style.display='none'">&times;</span></div>
            <div class="modal-body">
                <form id="add-form">
                    <input type="text" name="name" placeholder="Full Name" required style="width: 100%; margin-bottom: 15px;">
                    <input type="date" name="bday" required style="width: 100%; margin-bottom: 15px;">
                    <input type="text" name="pos" placeholder="Position" style="width: 100%; margin-bottom: 15px;">
                    <input type="text" name="mun" placeholder="Municipality" style="width: 100%; margin-bottom: 15px;">
                    <input type="text" name="contact" placeholder="Contact No." style="width: 100%; margin-bottom: 25px;">
                    <button type="submit" class="btn-main" style="width: 100%;">Save To Database</button>
                </form>
            </div>
        </div>
    </div>

    <script src="https://cdnjs.cloudflare.com/ajax/libs/moment.js/2.29.4/moment-with-locales.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.3.2/papaparse.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

    <script>
        // === CONFIGURATION ===
        const DB_NAME = 'D2BirthdayApp_v8_2'; 
        const DB_VER = 1;
        let db;
        let PRIORITY_MAP = {};
        let CURRENT_DATA = []; 
        let ALL_OFFICIALS_CACHE = []; 
        let sortState = { col: 'priority', dir: 'asc' };

        // === INITIALIZATION ===
        window.onload = async () => {
            await initDB();
            const count = await getCount('officials');
            if (count > 0) {
                loadApp();
            }
        };

        // === DATABASE ===
        function initDB() {
            return new Promise((resolve, reject) => {
                const req = indexedDB.open(DB_NAME, DB_VER);
                req.onupgradeneeded = e => {
                    const db = e.target.result;
                    if (!db.objectStoreNames.contains('officials')) db.createObjectStore('officials', { keyPath: 'id', autoIncrement: true });
                    if (!db.objectStoreNames.contains('logs')) {
                        const st = db.createObjectStore('logs', { keyPath: 'id', autoIncrement: true });
                        st.createIndex('date', 'date', { unique: false });
                        st.createIndex('refId_date', ['refId', 'date'], { unique: true });
                    }
                };
                req.onsuccess = e => { db = e.target.result; resolve(); };
                req.onerror = e => reject(e);
            });
        }

        function getCount(store) {
            return new Promise(resolve => {
                const tx = db.transaction(store, 'readonly');
                const req = tx.objectStore(store).count();
                req.onsuccess = () => resolve(req.result);
            });
        }

        // === IMPORT PROCESS ===
        document.getElementById('btn-import').onclick = async () => {
            const btn = document.getElementById('btn-import');
            const pBar = document.getElementById('progress-bar');
            const stat = document.getElementById('status-text');
            btn.style.display = 'none';
            stat.innerText = "Fetching Files...";

            try {
                // 1. Load Priority Levels
                const pRes = await fetch('data/priority_levels.csv');
                if(!pRes.ok) throw new Error("Missing data/priority_levels.csv");
                const pText = await pRes.text();
                const pData = Papa.parse(pText, { header: true, skipEmptyLines: true }).data;
                
                PRIORITY_MAP = {};
                pData.forEach(r => {
                    if(r.Position) {
                        // CRITICAL FIX: Normalize priority map keys
                        const key = r.Position.toUpperCase().trim();
                        PRIORITY_MAP[key] = parseInt(r.Level);
                    }
                });

                // 2. Load Masterlist
                const mRes = await fetch('data/masterlist.csv');
                if(!mRes.ok) throw new Error("Missing data/masterlist.csv");
                const mText = await mRes.text();
                const delim = mText.indexOf(';') > -1 ? ';' : ',';
                const mData = Papa.parse(mText, { header: true, delimiter: delim, skipEmptyLines: true }).data;

                // 3. Clear & Process
                const tx = db.transaction(['officials', 'logs'], 'readwrite');
                tx.objectStore('officials').clear();
                tx.objectStore('logs').clear();
                
                const total = mData.length;
                const chunkSize = 500;

                const headers = Object.keys(mData[0] || {});
                const nameKey = headers.find(h => h.toLowerCase().includes('name'));
                const bdayKey = headers.find(h => h.toLowerCase().includes('birthday'));
                const posKey = headers.find(h => h.toLowerCase().includes('position'));

                if (!nameKey || !bdayKey) throw new Error("CSV Headers Mismatch.");

                function processChunk(start) {
                    const txC = db.transaction('officials', 'readwrite');
                    const store = txC.objectStore('officials');
                    let i = start;
                    let end = start + chunkSize;
                    if(end > total) end = total;

                    while(i < end) {
                        const row = mData[i];
                        const name = row[nameKey];
                        const dateStr = row[bdayKey];
                        const rawPos = row[posKey] || 'N/A';
                        
                        if(name && dateStr) {
                            let mDate;
                             if (String(dateStr).match(/^\d{5}$/)) {
                                mDate = moment('1899-12-30').add(parseInt(dateStr), 'days');
                            } else {
                                mDate = moment(dateStr, ['YYYY-MM-DD', 'MM/DD/YYYY', 'D/M/YYYY', 'DD-MM-YYYY', 'M/D/YYYY'], true);
                            }

                            if(mDate.isValid() && mDate.year() > 1900) {
                                // CRITICAL FIX: Clean Masterlist Position before checking map
                                const cleanPos = rawPos.toUpperCase().trim();
                                const pLevel = PRIORITY_MAP[cleanPos] || 99;
                                
                                let mun = row['Municipality'] || row['municipality'] || '';
                                let brgy = row['Barangay'] || row['barangay'] || '';

                                store.add({
                                    name: name.trim(),
                                    bday: mDate.toDate(),
                                    month: mDate.month() + 1,
                                    day: mDate.date(),
                                    monthDay: mDate.format('MM-DD'),
                                    pos: rawPos.trim(), // Keep original display text
                                    mun: mun.trim().toUpperCase(),
                                    brgy: brgy.trim(),
                                    contact: (row['Contact No.']||'').trim(),
                                    priority: pLevel
                                });
                            }
                        }
                        i++;
                    }

                    const pct = Math.round((i/total)*100);
                    pBar.style.width = pct + "%";
                    stat.innerText = `Processing ${i} of ${total}`;

                    txC.oncomplete = () => {
                        if(i < total) setTimeout(() => processChunk(i), 10);
                        else {
                            stat.innerText = "Complete!";
                            setTimeout(loadApp, 500);
                        }
                    };
                }
                processChunk(0);

            } catch(err) {
                stat.innerText = "Error: " + err.message;
                stat.style.color = "red";
            }
        };

        // === APP LOGIC ===
        async function loadApp() {
            document.getElementById('import-screen').style.display = 'none';
            document.getElementById('app-screen').style.display = 'block';
            
            document.getElementById('filter-search').onkeyup = renderList;
            document.getElementById('filter-mun').onchange = renderList;
            document.getElementById('filter-month').onchange = renderList;
            document.getElementById('toggle-priority').onchange = renderList;
            document.getElementById('add-form').onsubmit = handleAdd;

            await refreshAll();
        }

        async function refreshAll() {
            setLoading(true);
            ALL_OFFICIALS_CACHE = [];
            const tx = db.transaction('officials', 'readonly');
            tx.objectStore('officials').openCursor().onsuccess = e => {
                const c = e.target.result;
                if(c) {
                    ALL_OFFICIALS_CACHE.push({id: c.key, ...c.value});
                    c.continue();
                } else {
                    populateFilters();
                    const logTx = db.transaction('logs', 'readonly');
                    const todayStr = moment().format('YYYY-MM-DD');
                    const loggedIds = new Set();
                    logTx.objectStore('logs').openCursor().onsuccess = ev => {
                        const cur = ev.target.result;
                        if(cur) {
                            if(cur.value.date === todayStr) loggedIds.add(cur.value.refId);
                            cur.continue();
                        } else {
                            ALL_OFFICIALS_CACHE.forEach(p => p.isLogged = loggedIds.has(p.id));
                            updateDashboard();
                            renderList();
                            renderMainCharts();
                            setLoading(false);
                        }
                    };
                }
            };
        }

        function setLoading(isLoading) {
            const spin = document.getElementById('loading-spinner');
            spin.style.display = isLoading ? 'block' : 'none';
        }

        // === DASHBOARD ===
        function updateDashboard() {
            const today = moment().format('MM-DD');
            let todayCount = 0, prioCount = 0, upcoming = 0, logged = 0;
            const start = moment().startOf('day');
            const end = moment().add(7, 'days');

            ALL_OFFICIALS_CACHE.forEach(p => {
                if(p.monthDay === today) {
                    todayCount++;
                    if(p.priority <= 5) prioCount++; 
                }
                if(p.isLogged) logged++;
                const bday = moment(p.bday).year(moment().year());
                if(bday.isBetween(start, end, 'day', '[]')) upcoming++;
            });

            document.getElementById('d-today').innerText = todayCount;
            document.getElementById('d-prio').innerText = prioCount;
            document.getElementById('d-upcoming').innerText = upcoming;
            document.getElementById('d-total').innerText = ALL_OFFICIALS_CACHE.length;
        }

        // === LIST RENDERING ===
        function renderList() {
            const search = document.getElementById('filter-search').value.toLowerCase();
            const mun = document.getElementById('filter-mun').value;
            const month = document.getElementById('filter-month').value;
            const prioOnly = document.getElementById('toggle-priority').checked;

            let data = ALL_OFFICIALS_CACHE.filter(p => {
                if(search && !p.name.toLowerCase().includes(search)) return false;
                if(mun && p.mun !== mun) return false;
                if(month && p.month != month) return false;
                if(prioOnly && p.priority > 5) return false;
                return true;
            });

            CURRENT_DATA = data;

            data.sort((a,b) => {
                const dir = sortState.dir === 'asc' ? 1 : -1;
                if(sortState.col === 'priority') return (a.priority - b.priority) * dir;
                if(sortState.col === 'bday') return ((a.month*100+a.day) - (b.month*100+b.day)) * dir;
                if(sortState.col === 'name' || sortState.col === 'mun') return a[sortState.col].localeCompare(b[sortState.col]) * dir;
                return 0;
            });

            document.getElementById('count-text').innerText = `Showing ${Math.min(200, data.length)} of ${data.length} matches`;
            const tbody = document.getElementById('table-body');
            
            if (data.length === 0) {
                tbody.innerHTML = '<tr><td colspan="8" style="text-align:center; padding:30px;">No records found.</td></tr>';
                return;
            }

            const displayData = data.slice(0, 200); 
            tbody.innerHTML = displayData.map(p => `
                <tr>
                    <td><span class="badge" data-p="${p.priority}">P${p.priority}</span></td>
                    <td>${moment(p.bday).format('MMM D')}</td>
                    <td class="name-p${p.priority}">${p.name}</td>
                    <td>${p.pos}</td>
                    <td>${p.brgy}</td>
                    <td>${p.mun}</td>
                    <td>${p.contact ? `<a href="tel:${p.contact}" style="color:inherit;">${p.contact}</a>` : ''}</td>
                    <td>
                        <button class="btn-main ${p.isLogged?'logged':''}" 
                                style="font-size:0.75rem; padding: 6px 12px; background: ${p.isLogged?'#aaa':''}; box-shadow: none;"
                                onclick="toggleLog(${p.id}, ${p.isLogged})">
                            ${p.isLogged ? 'Un-Log' : 'Log'}
                        </button>
                    </td>
                </tr>
            `).join('');
        }

        function handleSort(col) {
            if(sortState.col === col) sortState.dir = sortState.dir === 'asc' ? 'desc' : 'asc';
            else { sortState.col = col; sortState.dir = 'asc'; }
            renderList();
        }

        function populateFilters() {
            const muns = new Set();
            ALL_OFFICIALS_CACHE.forEach(p => { if(p.mun) muns.add(p.mun); });
            const sel = document.getElementById('filter-mun');
            const currentVal = sel.value;
            sel.innerHTML = '<option value="">All Municipalities</option>';
            Array.from(muns).sort().forEach(m => {
                const opt = document.createElement('option');
                opt.value = m; opt.innerText = m;
                sel.appendChild(opt);
            });
            sel.value = currentVal; 
        }

        // === POPUPS & CHARTS ===
        function openQuickView(type) {
            const today = moment().format('MM-DD');
            let data = [];
            let title = "";
            
            if(type === 'today') {
                data = ALL_OFFICIALS_CACHE.filter(p => p.monthDay === today);
                title = "Today's Birthdays";
            } else if (type === 'priority') {
                data = ALL_OFFICIALS_CACHE.filter(p => p.monthDay === today && p.priority <= 5);
                title = "Priority Birthdays (L1-L5)";
            } else if (type === 'upcoming') {
                 const start = moment().startOf('day');
                 const end = moment().add(7, 'days');
                 data = ALL_OFFICIALS_CACHE.filter(p => moment(p.bday).year(moment().year()).isBetween(start, end, 'day', '[]'));
                 title = "Upcoming 7 Days";
            }

            document.getElementById('modal-title').innerText = title;
            const tbody = document.getElementById('modal-body-content');
            tbody.innerHTML = data.map(p => `
                <tr>
                    <td><span class="badge" data-p="${p.priority}">P${p.priority}</span></td>
                    <td>${moment(p.bday).format('MMM D')}</td>
                    <td class="name-p${p.priority}">${p.name}</td>
                    <td>${p.pos}</td>
                    <td>${p.contact}</td>
                    <td><button class="btn-main" style="font-size:0.7rem; padding:5px; box-shadow: none;" onclick="toggleLog(${p.id}, ${p.isLogged}); this.innerText='Done'">Log</button></td>
                </tr>
            `).join('');
            document.getElementById('modal-quick').style.display = 'block';
        }

        // NEW: TOTAL OFFICIALS POPUP (Interactive Graph)
        let totalChart;
        function openTotalStats() {
            document.getElementById('modal-total').style.display = 'block';
            
            const months = Array(12).fill(0);
            ALL_OFFICIALS_CACHE.forEach(p => months[p.month - 1]++);
            
            const ctx = document.getElementById('chart-total-popup').getContext('2d');
            if(totalChart) totalChart.destroy();
            
            totalChart = new Chart(ctx, {
                type: 'line',
                data: {
                    labels: ['Jan','Feb','Mar','Apr','May','Jun','Jul','Aug','Sep','Oct','Nov','Dec'],
                    datasets: [{
                        label: 'Birthdays per Month',
                        data: months,
                        borderColor: '#126c39',
                        backgroundColor: 'rgba(18, 108, 57, 0.1)',
                        fill: true,
                        tension: 0.4,
                        pointRadius: 5,
                        pointHoverRadius: 8
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: { legend: {display: false} },
                    scales: { y: {beginAtZero: true} }
                }
            });
        }

        // MAIN CHARTS (Rank Distribution)
        let chartDist, chartPie;
        function renderMainCharts() {
            // Prepare Data for Specific Groups
            const counts = { p1:0, p2:0, p3:0, p4:0, p5:0 };
            ALL_OFFICIALS_CACHE.forEach(p => {
                if(p.priority === 1) counts.p1++;
                if(p.priority === 2) counts.p2++;
                if(p.priority === 3) counts.p3++;
                if(p.priority === 4) counts.p4++;
                if(p.priority === 5) counts.p5++;
            });

            // Destroy Old
            if(chartDist) chartDist.destroy();
            if(chartPie) chartPie.destroy();

            Chart.defaults.font.family = "'Poppins', sans-serif";

            // 1. BAR GRAPH: Breakdown by Level
            const ctx1 = document.getElementById('chart-distribution').getContext('2d');
            chartDist = new Chart(ctx1, {
                type: 'bar',
                data: {
                    labels: ['Mayors/VM (P1)', 'Councilors (P2)', 'Captains (P3)', 'Kagawads (P4)', 'SK Chair (P5)'],
                    datasets: [{
                        label: 'Count',
                        data: [counts.p1, counts.p2, counts.p3, counts.p4, counts.p5],
                        backgroundColor: ['#a9181d', '#f57f17', '#0277bd', '#2e7d32', '#607D8B'],
                        borderRadius: 5
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {display: false},
                        title: {display: true, text: 'Official Distribution by Rank', font: {size: 16}}
                    },
                    scales: { y: {beginAtZero: true} }
                }
            });

            // 2. PIE GRAPH: Overall Mix
            const ctx2 = document.getElementById('chart-pie').getContext('2d');
            chartPie = new Chart(ctx2, {
                type: 'doughnut',
                data: {
                    labels: ['P1','P2','P3','P4','P5','Others'],
                    datasets: [{ 
                        data: [counts.p1, counts.p2, counts.p3, counts.p4, counts.p5, ALL_OFFICIALS_CACHE.length - (counts.p1+counts.p2+counts.p3+counts.p4+counts.p5)], 
                        backgroundColor: ['#a9181d', '#f57f17', '#0277bd', '#2e7d32', '#607D8B', '#e0e0e0'] 
                    }]
                },
                options: { responsive: true, maintainAspectRatio: false, plugins: {title: {display: true, text: 'Database Composition', font: {size: 16}}} }
            });
        }

        // === LOGGING & EXPORT ===
        async function toggleLog(id, isLogged) {
            const date = moment().format('YYYY-MM-DD');
            const tx = db.transaction('logs', 'readwrite');
            const store = tx.objectStore('logs');

            if(isLogged) {
                if(!confirm("Un-log this greeting?")) return;
                const idx = store.index('refId_date');
                const req = idx.getKey([id, date]);
                req.onsuccess = e => { if(e.target.result) store.delete(e.target.result); };
            } else {
                store.add({ refId: id, date: date, timestamp: new Date() });
            }
            tx.oncomplete = () => refreshAll();
        }

        function handleExportCSV() {
            if(!CURRENT_DATA.length) return alert("No data to export");
            let csv = "Priority,Birthday,Name,Position,Barangay,Municipality,Contact,Logged\n";
            CURRENT_DATA.forEach(p => {
                csv += `P${p.priority},${moment(p.bday).format('YYYY-MM-DD')},"${p.name}","${p.pos}","${p.brgy}","${p.mun}","${p.contact}",${p.isLogged?'Yes':'No'}\n`;
            });
            const blob = new Blob([csv], {type:'text/csv'});
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url; a.download = 'Birthday_Export.csv';
            a.click();
        }

        async function handleAdd(e) {
            e.preventDefault();
            const f = e.target;
            if(!f.name.value || !f.bday.value) return alert("Name/Bday required");
            const mDate = moment(f.bday.value);
            const tx = db.transaction('officials', 'readwrite');
            tx.objectStore('officials').add({
                name: f.name.value, bday: mDate.toDate(), month: mDate.month()+1, day: mDate.date(),
                monthDay: mDate.format('MM-DD'), pos: f.pos.value, mun: f.mun.value.toUpperCase(),
                contact: f.contact.value, priority: 99, brgy: ''
            });
            tx.oncomplete = () => {
                alert("Added!"); document.getElementById('modal-add').style.display='none';
                f.reset(); refreshAll();
            };
        }
    </script>
</body>
</html>